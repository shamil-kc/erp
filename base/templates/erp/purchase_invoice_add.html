{% extends 'erp/base.html' %}
{% block content %}
<h2 class="mb-4">Add Purchase Invoice</h2>
<form method="post">{% csrf_token %}
  <div class="mb-3">
    <label for="invoice_no" class="form-label">Invoice No</label>
    <input type="text" id="invoice_no" name="invoice_no" class="form-control" required>
  </div>
  <div class="mb-3">
    <label for="purchase_date" class="form-label">Purchase Date</label>
    <input type="date" id="purchase_date" name="purchase_date" class="form-control" value="{{ today|default:'' }}" required>
  </div>
  <div class="mb-3">
    <label for="supplier" class="form-label">Supplier</label>
    <input type="text" id="supplier" name="supplier" class="form-control">
  </div>
  <div class="mb-3">
    <label for="notes" class="form-label">Notes</label>
    <input type="text" id="notes" name="notes" class="form-control">
  </div>

  <table id="purchase-table" class="mb-4">
    <thead>
      <tr>
        <th>Product Item</th><th>Qty</th><th>Unit Price USD</th>
        <th>Unit Price AED</th><th>Shipping USD</th>
        <th>Shipping AED</th><th>Factors</th><th></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>
          <select name="form-0-item" class="form-select" required>
            <option value="" selected disabled>Choose Item</option>
            {% for i in items %}
              <option value="{{ i.id }}">{{ i.grade.product_type.product.name }} / {{ i.grade.product_type.type_name }} / {{ i.grade.grade }} / Size: {{ i.size }}</option>
            {% endfor %}
          </select>
        </td>
        <td><input type="number" min="1" name="form-0-qty" class="form-control" required></td>
        <td><input type="number" step="0.01" name="form-0-unit_price_usd" class="form-control" required></td>
        <td><input type="number" step="0.01" name="form-0-unit_price_aed" class="form-control" required></td>
        <td><input type="number" step="0.01" name="form-0-shipping_per_unit_usd" class="form-control" value="0"></td>
        <td><input type="number" step="0.01" name="form-0-shipping_per_unit_aed" class="form-control" value="0"></td>
        <td><input type="text" name="form-0-factors" class="form-control"></td>
        <td>
          <button type="button" onclick="removeRow(this)" class="btn btn-sm btn-danger" title="Delete">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      </tr>
    </tbody>
  </table>

  <input type="hidden" id="form-TOTAL_FORMS" name="form-TOTAL_FORMS" value="1">
  <button type="button" onclick="addRow()" class="btn btn-outline-primary mb-3">
    <i class="bi bi-plus-lg"></i> Add Another
  </button><br>
  <button type="submit" class="btn btn-success">Submit Invoice</button>
</form>

<script>
function addRow() {
    const tableBody = document.querySelector('#purchase-table tbody');
    if (!tableBody) return;
    const firstRow = tableBody.querySelector('tr');
    if (!firstRow) return;
    const newRow = firstRow.cloneNode(true);
    const formNum = parseInt(document.getElementById('form-TOTAL_FORMS').value);

    [...newRow.querySelectorAll('input, select')].forEach(el => {
        let name = el.getAttribute('name');
        if (name) {
            let newName = name.replace(/form-\d+-/, `form-${formNum}-`);
            el.setAttribute('name', newName);
        }
        if (el.tagName.toLowerCase() === 'select') {
            el.selectedIndex = 0;
        } else if (el.type === 'number') {
            el.value = el.name && el.name.includes('qty') ? '' : '0';
        } else {
            el.value = '';
        }
    });

    tableBody.appendChild(newRow);
    document.getElementById('form-TOTAL_FORMS').value = formNum + 1;
}

function removeRow(btn) {
    const tableBody = document.getElementById('purchase-table').getElementsByTagName('tbody')[0];
    if (tableBody.rows.length > 1) {
        btn.closest('tr').remove();
        document.getElementById('form-TOTAL_FORMS').value = tableBody.rows.length;
    } else {
        [...btn.closest('tr').querySelectorAll('input')].forEach(el => {
            el.value = (el.type === 'number') ? (el.name.includes('qty') ? '' : '0') : '';
        });
        const select = btn.closest('tr').querySelector('select');
        if (select) {
            select.selectedIndex = 0;
        }
    }
}
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
{% endblock %}
