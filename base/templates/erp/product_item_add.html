{% extends 'erp/base.html' %}
{% load static %}
{% block content %}
<h2>Add Product Item(s)</h2>
<form method="post" id="productitem-form">{% csrf_token %}
  <table id="item-table" class="mb-4">
    <thead>
      <tr>
        <th>Product</th>
        <th>Type</th>
        <th>Grade</th>
        <th>Size</th>
        <th>Unit</th>
        <th>Unit Weight (kg)</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>
          <input list="products" name="form-0-product" class="form-control" required>
          <datalist id="products">
            {% for p in products %}<option value="{{ p }}">{% endfor %}
          </datalist>
        </td>
        <td>
          <input list="types" name="form-0-product_type" class="form-control" required>
          <datalist id="types">
            {% for t in types %}<option value="{{ t }}">{% endfor %}
          </datalist>
        </td>
        <td>
          <input list="grades" name="form-0-grade" class="form-control" required>
          <datalist id="grades">
            {% for g in grades %}<option value="{{ g }}">{% endfor %}
          </datalist>
        </td>
        <td><input type="number" step="any" name="form-0-size" class="form-control" required></td>
        <td><input type="text" name="form-0-unit" value="PCs" class="form-control" required></td>
        <td><input type="number" step="any" name="form-0-weight_kg_each" class="form-control" required></td>
        <td>
          <button type="button" onclick="removeRow(this)" class="btn btn-sm btn-danger" title="Delete"><i class="bi bi-trash"></i></button>
        </td>
      </tr>
    </tbody>
  </table>
  <input type="hidden" id="form-TOTAL_FORMS" name="form-TOTAL_FORMS" value="1">
  <button type="button" onclick="addRow()" class="btn btn-outline-primary mb-3"><i class="bi bi-plus-lg"></i> Add Another</button><br>

  <button type="submit" class="btn btn-success">Submit All</button>
</form>
<script>
function addRow() {
    const table = document.getElementById('item-table').getElementsByTagName('tbody')[0];
    const formNum = parseInt(document.getElementById('form-TOTAL_FORMS').value);
    const newRow = table.rows[0].cloneNode(true);
    [...newRow.querySelectorAll('input')].forEach(el => {
        let name = el.getAttribute('name').replace(/\d+/, formNum);
        el.setAttribute('name', name);
        el.value = (el.type === 'text' && name.includes('unit')) ? 'PCs' : '';
    });
    table.appendChild(newRow);
    document.getElementById('form-TOTAL_FORMS').value = formNum + 1;
}
function removeRow(btn) {
    const table = document.getElementById('item-table').getElementsByTagName('tbody')[0];
    if(table.rows.length > 1){
        btn.closest('tr').remove();
        document.getElementById('form-TOTAL_FORMS').value = table.rows.length;
    } else {
        // just clear the first row if only one left
        [...btn.closest('tr').querySelectorAll('input')].forEach(el => { el.value=''; });
    }
}
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
{% endblock %}
